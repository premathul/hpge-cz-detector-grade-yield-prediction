import oss(shap_values_reshaped).mean(axis=1),
import shapened,
import numpy as npdf_features.columns,
import pandas as pd,
import tensorflow as tf
import matplotlib
matplotlib.use('Agg')  # Use headless backend for saving plots00)
import matplotlib.pyplot as plt
from tensorflow.keras.preprocessing.sequence import pad_sequences
print("plots saved as:")
# === Suppress logs and fix HDF5 ===
os.environ["TF_CPP_MIN_LOG_LEVEL"] = "2"
os.environ["HDF5_USE_FILE_LOCKING"] = "FALSE"

model_path = "performedmodel.keras"
lstm_model = tf.keras.models.load_model(model_path)

# === Load dataset ===
data_path = "strict_full_converted_data.csv"
df = pd.read_csv(data_path)

# Drop non-numeric or unused columns
if "SheetName" in df.columns:
    df.drop(columns=["SheetName"], inplace=True)

# Extract features and target
target_column = "Detector grade portion (%)"
features = [col for col in df.columns if col != target_column]
df_features = df[features].copy()
df_target = df[target_column].copy()

X = df_features.to_numpy()
y = df_target.to_numpy()

# Parameters
num_features = X.shape[1]
max_sequence_length = 38
X_reshaped = X.reshape(-1, 1, num_features)
X_padded = pad_sequences(X_reshaped, maxlen=max_sequence_length, padding="post", dtype="float32")
X_shap_ready = X_padded.reshape(X_padded.shape[0], -1)
print("Final reshaped input for SHAP:", X_shap_ready.shape)

# SHAP background and test samples
background_samples = X_shap_ready[:50]
test_samples = X_shap_ready[:100]
def model_predict(X_input_flat):
    reshaped_input = X_input_flat.reshape((-1, max_sequence_length, num_features))
    return lstm_model.predict(reshaped_input, verbose=0)

# Run SHAP
explainer = shap.KernelExplainer(model_predict, background_samples)
print("Running SHAP value computation... this may take time.")
shap_values = explainer.shap_values(test_samples)
shap_values_reshaped = np.array(shap_values).reshape(-1, max_sequence_length, num_features)
X_flattened = X[:100]


print("Saving SHAP summary scatter plot...")
plt.figure()
shap.summary_plot(
    shap_values_reshaped.mean(axis=1),
    X_flattened,
    feature_names=df_features.columns,
    show=False
)
plt.savefig("shap_summary_scatter.png", bbox_inches="tight", dpi=300)
plt.close()

# === Save SHAP bar plot for global importance ===
print("Saving SHAP feature importance bar plot...")
plt.figure()
shap.summary_plot(
    np.abs(shap_values_reshaped).mean(axis=1),
    X_flattened,
    feature_names=df_features.columns,
    plot_type="bar",
    show=False
)
plt.savefig("shap_summary_bar.png", bbox_inches="tight", dpi=300)
plt.close()


print("   - shap_summary_scatter.png")
print("   - shap_summary_bar.png")

